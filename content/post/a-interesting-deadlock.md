---
title: "ä¸€ç§æœ‰æ„æ€çš„æ­»é”"
date: 2019-01-16T22:43:13+08:00
lastmod: 2019-01-16T22:43:13+08:00
draft: false
keywords: []
description: ""
tags: ["sticker"]
categories: ["sticker"]
author: ""

# You can also close(false) or open(true) something for this content.
# P.S. comment can only be closed
comment: true
toc: false
autoCollapseToc: false
postMetaInFooter: false
hiddenFromHomePage: false
# You can also define another contentCopyright. e.g. contentCopyright: "This is another copyright."
contentCopyright: false
reward: false
mathjax: false
mathjaxEnableSingleDollar: false
mathjaxEnableAutoNumber: false

# You unlisted posts you might want not want the header or footer to show
hideHeaderAndFooter: false

# You can enable or disable out-of-date content warning for individual post.
# Comment this out to use the global config.
#enableOutdatedInfoWarning: false

flowchartDiagrams:
  enable: false
  options: ""

sequenceDiagrams: 
  enable: false
  options: ""

---

åˆšé—²é€›æ—¶å€™å‘ç°æœ‰[ä¸€ç¯‡æ–‡ç« ](https://python-gino.readthedocs.io/zh/latest/why.html#the-story)è®²äº†ä¸€ç§æœ‰æ„æ€çš„æ­»é”ï¼Œä¸æ˜¯äº²èº«ç»å†ï¼Œä½†æ˜¯ä¹Ÿå¾ˆæœ‰æ„æ€äº†ã€‚

å…ˆä¼šè®®ä¸€ä¸‹æ­»é”çš„å®šä¹‰æ˜¯ä»€ä¹ˆï¼Ÿç¿»å‡ºå‹ç®±åº•çš„`ç°ä»£æ“ä½œç³»ç»Ÿ`:

> å¦‚æœä¸€ä¸ªè¿›ç¨‹é›†åˆä¸­çš„æ¯ä¸ªè¿›ç¨‹éƒ½åªèƒ½ç­‰å¾…ç”±è¯¥è¿›ç¨‹é›†åˆä¸­çš„å…¶ä»–è¿›ç¨‹æ‰èƒ½å¼•å‘çš„äº‹ä»¶ï¼Œé‚£ä¹ˆï¼Œè¯¥è¿›ç¨‹é›†åˆå°±æ˜¯æ­»é”çš„ã€‚

æ‰€ä»¥ï¼Œè¿˜æ˜¯ä¸çŸ¥é“ä»€ä¹ˆæ˜¯æ­»é”ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œ

> æ¯”å¦‚ç”²ä¹™ä¸¤äººåŒæ—¶å»é£Ÿå ‚åƒé¥­ï¼Œé£Ÿå ‚é‡Œé¢åªæœ‰ä¸€ä¸ªç¢—å’Œä¸€åŒç­·å­ï¼Œç”²æŠ¢åˆ°äº†ç¢—ï¼Œä¹™æŠ¢åˆ°äº†ç­·å­ï¼Œç”²ç­‰ä¹™æ”¾ä¸‹ç­·å­ï¼Œä¹™ç­‰ç”²æ”¾ä¸‹ç¢—ï¼Œç»“æœä¸¤ä¸ªäººéƒ½é¥¿æ­»äº†ã€‚

åˆæ¯”å¦‚:

> Aå’ŒBä¸¤ä¸ªè¿›ç¨‹åŒæ—¶å»å†™æ•°æ®åº“ï¼ŒAé”ä½äº†ç¬¬nè¡Œå»è¯»ç¬¬mè¡Œï¼ŒBé”ä½äº†ç¬¬mè¡Œå»è¯»ç¬¬nè¡Œï¼Œç»“æœAï¼ŒBéƒ½æ— é™æœŸç­‰ä¸‹å»äº†ã€‚

æ— è®ºæ˜¯`ç”²`,`ä¹™`,è¿˜æ˜¯`A`,`B`,éƒ½åœ¨ç­‰å¾…å¦ä¸€ä¸ªå·²ç»æ­»é”çš„è¿›ç¨‹é‡Šæ”¾èµ„æºã€‚å› ä¸ºæ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¸èƒ½è¿è¡Œï¼Œæ‰€ä»¥èµ„æºæ°¸è¿œæ— æ³•è¢«é‡Šæ”¾ï¼Œæ‰€ä»¥æ‰€æœ‰è¿›ç¨‹éƒ½ä¸èƒ½è¢«å”¤é†’ã€‚è¿›ç¨‹çš„æ•°é‡ä»¥åŠå æœ‰å’Œè¯·æ±‚çš„èµ„æºæ•°é‡éƒ½æ˜¯æ— å…³ç´§è¦çš„ï¼Œè€Œæ— è®ºèµ„æºå’Œä½•ç§ç±»å‹éƒ½ä¼šå‘ç”Ÿä½•ç§ç»“æœï¼Œæ‰€ä»¥è¿™ç§æ­»é”è¢«ç§°ä¸ºèµ„æºæ­»é”ã€‚

å¥½äº†ï¼ŒæŠ„ä¹¦ç»“æŸï¼Œåˆ’é‡ç‚¹ã€‚

å¥½å§ï¼Œä¸Šé¢è¿™æ®µè¯éƒ½æ˜¯é‡ç‚¹ã€‚

åºŸè¯ğŸ‘†

ä¸‹é¢çœ‹`å æœ‰å’Œè¯·æ±‚çš„èµ„æºæ•°é‡éƒ½æ˜¯æ— å…³ç´§è¦çš„ğŸŒ°`

> For example, the first coroutine starts a transaction and updated a row, then the second coroutine tries to update the same row before the first coroutine closes the transaction. The second coroutine will block the whole thread at the non-async update, waiting for the row lock to be released, but the releasing is in the first coroutine which is blocked by the second coroutine. Thus it will block forever.

ä¹‹å‰åœ¨åç¨‹ä¸­ï¼Œæ¯æ—¶æ¯åˆ»å®é™…éƒ½åªæœ‰ä¸€ä»¶äº‹åœ¨æ‰§è¡Œï¼Œå‘ç”Ÿæ­»é”çš„æ¦‚ç‡åº”è¯¥ä¸é«˜å§ã€‚too youngå•Š

æ¯”å¦‚ç¬¬ä¸€ä¸ªåç¨‹å‘èµ·äº‹åŠ¡æ›´æ–°æ•°æ®åº“ä¸­çš„ä¸€è¡Œï¼Œè¿™æ—¶å€™ç¬¬äºŒä¸ªåç¨‹è¯•å›¾æ›´æ–°åŒä¸€è¡Œï¼Œå¦‚æœç¬¬äºŒä¸ªåç¨‹æ˜¯éå¼‚æ­¥çš„æ›´æ–°ï¼Œé‚£ä¹ˆå®ƒå°±è¦ç­‰å¾…ç¬¬ä¸€ä¸ªåç¨‹é‡Šæ”¾èµ„æºï¼Œä½†æ˜¯è¿™æ—¶å€™æ•´ä¸ªçº¿ç¨‹å·²ç»è¢«ç¬¬äºŒä¸ªçº¿ç¨‹é˜»å¡äº†ï¼Œç¬¬ä¸€ä¸ªåç¨‹æ— æ³•é‡Šæ”¾èµ„æºï¼Œdeadlock!

å›å¿†ä¸€ä¸‹ä¹¦æœ¬ä¸­å…³äºèµ„æºæ­»é”çš„å››ä¸ªæ¡ä»¶ï¼Œå›å¿†ä¸€ä¸‹:

1. äº’æ–¥æ¡ä»¶
2. å æœ‰å’Œç­‰å¾…æ¡ä»¶
3. ä¸å¯æŠ¢å æ¡ä»¶
4. ç¯è·¯ç­‰å¾…æ¡ä»¶

è¿™å››ä¸ªæ¡ä»¶åªè¦æœ‰ä¸€ä¸ªä¸æˆç«‹é‚£ä¹ˆèµ„æºæ­»é”å°±ä¸ä¼šå‘ç”Ÿã€‚

å¥½äº†ç°åœ¨å¥—ç”¨ä¸€ä¸‹ä¸Šé¢è¿™ä¸ªä¾‹å­ã€‚

1. æ•°æ®åº“è¡Œé”å’Œå½“å‰çº¿ç¨‹æ‰§è¡Œéƒ½æ˜¯äº’æ–¥çš„ï¼Œâœ…
2. ç¬¬ä¸€ä¸ªåç¨‹å æœ‰äº†æ•°æ®åº“ä¸­çš„é”ç­‰å¾…çº¿ç¨‹æ‰§è¡Œæƒï¼Œç¬¬äºŒä¸ªåç¨‹å æœ‰äº†å½“å‰åç¨‹çš„æ‰§è¡Œç­‰å¾…è¡Œé”ï¼Œâœ…
3. ä¸å¯æŠ¢å ï¼Œâœ…
4. ç¯è·¯ç­‰å¾…ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹ç­‰å¾…è¡Œé”ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…æœ‰æœºä¼šè¢«æ‰§è¡Œï¼Œâœ…

æ­»é”bingo!

æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ

> A simple fix would be to defer the database operations into threads, so that they won't block the main thread, thus won't cause a dead lock easily. It usually works and there is even a library to do so. However when it comes to ORM, things become dirty.

æŠŠæ•°æ®åº“ç›¸å…³æ“ä½œæ‰”ç»™å…¶ä»–çº¿ç¨‹å»æ‰§è¡Œï¼Œç¡®ä¿ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹å°±è¡Œäº†ã€‚

ä½†æ˜¯çœŸçš„å°±è¡Œäº†å—ï¼Ÿ

åœ¨ä¸€ä¸ªå¤æ‚çš„é¡¹ç›®ä¸­ï¼Œä½ æ°¸è¿œä¸çŸ¥é“å“ªä¸€è¡Œä»£ç ä¼šè°ƒç”¨åŒæ­¥ä»£ç é˜»å¡ä¸»çº¿ç¨‹ï¼Œ`Racing condition just happens under pressure, and anything that may block will eventually block`, å¯èƒ½ä¼šå‘ç”Ÿçš„äº‹æƒ…ç»ˆå°†è¦å‘ç”Ÿã€‚

æ‰€ä»¥ä½œè€…å»ºè®®:

> This is usually the time when I suggest to separate the server into two parts: "normal blocking with ORM" and "asynchronous without ORM".

ä¸è¿‡å€’æ˜¯æƒ³èµ·å¦å¤–ä¸€ä¸ªé—®é¢˜äº†, ç°åœ¨å…¬å¸ä¸šåŠ¡éƒ½æ˜¯ç”¨çš„`gunicorn`+`gevent`, è¿™ä¸ªå†…éƒ¨æ˜¯æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Œæƒ³ä¸æ˜ç™½è¯¶ã€‚ã€‚ã€‚

ä¸è¿‡è”æƒ³åˆ°`gevent`çš„åç¨‹æ˜¯æŠ¢å å¼çš„ï¼Œä¼šä¸ä¼šæ˜¯å› ä¸ºç ´åäº†`ä¸å¯æŠ¢å æ¡ä»¶`è€Œé¿å…äº†æ­»é”å‘¢ï¼Œç»™è‡ªå·±ç•™ä¸ªé—®é¢˜å§ã€‚

å‚è€ƒèµ„æ–™ï¼š

1. ç°ä»£æ“ä½œç³»ç»Ÿ
2. https://python-gino.readthedocs.io/zh/latest/why.html#the-story
<!--more-->
